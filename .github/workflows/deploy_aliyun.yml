name: NodeJS with Webpack Deploy to Aliyun ECS

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [18.19.1]

    steps:
    - uses: actions/checkout@v4

    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}

    - name: Build
      run: |
        npm install
        npx webpack

    - name: Deploy to Aliyun ECS
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.ALIYUN_HOST }}
        username: ${{ secrets.ALIYUN_USERNAME }}
        key: ${{ secrets.ALIYUN_SERVER_SSH_KEY }}
        script: |
          #!/bin/bash

          # 设置脚本执行失败时退出
          set -e

          # 定义日志文件路径
          LOG_FILE="/home/garyli/git_action_webpack_starter/deploy_log.txt"

          # 定义记录日志的函数
          log() {
            local timestamp
            timestamp=$(date +"%Y-%m-%d %H:%M:%S")
            echo "[$timestamp] $1" | tee -a "$LOG_FILE"
          }

          # 记录脚本开始执行的日志
          log "Deploy script started."

          # 确保目标目录存在
          log "Ensuring the target directory exists..."
          mkdir -p /home/garyli/git_action_webpack_starter

          # 同步仓库
          # log "Cloning or updating the repository..."
          # if [ -d "/home/garyli/git_action_webpack_starter/webpack_starter" ]; then
          #   cd /home/garyli/git_action_webpack_starter/webpack_starter
          #   git pull origin main
          # else
          #   git clone https://github.com/garylivip/webpack_starter.git /home/garyli/git_action_webpack_starter/webpack_starter
          #   cd /home/garyli/git_action_webpack_starter/webpack_starter
          # fi
          # log "Repository cloned or updated successfully."

          # 安装依赖包
          # log "Installing dependencies..."
          # npm install
          # log "Dependencies installed successfully."

          # 构建项目
          # log "Building the project..."
          # npm run build
          # log "Project built successfully."

          # 传输构建文件
          log "Transferring the built files..."
          rsync -avz --exclude='.git' --exclude='node_modules' --exclude='.github' --exclude='**/node_modules' . /home/garyli/git_action_webpack_starter
          log "Files transferred successfully."

          # 重启应用服务
          # log "Restarting the application..."
          # systemctl restart your-application.service
          # log "Application restarted successfully."

          # 记录脚本执行完成的日志
          log "Deploy script completed."